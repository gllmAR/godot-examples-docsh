name: ðŸŽ® Build Godot Examples Documentation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all projects'
        required: false
        default: false
        type: boolean
      godot_version:
        description: 'Godot version to use for building'
        required: false
        default: '4.4.1'
        type: string

env:
  GODOT_VERSION: ${{ github.event.inputs.godot_version || '4.4.1' }}
  GODOT_VERSION_STABLE: ${{ github.event.inputs.godot_version || '4.4.1' }}-stable
  GODOT_TEMPLATE_VERSION: ${{ github.event.inputs.godot_version || '4.4.1' }}.stable
  PYTHON_VERSION: "3.11"

jobs:
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      build-needed: ${{ steps.changes.outputs.build-needed }}
      projects-changed: ${{ steps.changes.outputs.projects-changed }}
      docs-changed: ${{ steps.changes.outputs.docs-changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          submodules: true

      - name: Initialize and update submodules
        run: |
          echo "ðŸ“¦ Ensuring submodules are properly initialized..."
          git submodule update --init --recursive --depth 1

      - name: Detect changes
        id: changes
        run: |
          echo "ðŸ” Checking for changes that require rebuilding..."
          echo "Files changed in last commit:"
          git diff --name-only HEAD~1 || echo "No changes detected"
          
          # Check if build system or projects changed
          if git diff --name-only HEAD~1 | grep -E "(build_system/|godot-demo-projects/|\.py$|\.sh$|\.github/workflows/)" || [ "${{ github.event.inputs.force_rebuild }}" == "true" ]; then
            echo "build-needed=true" >> $GITHUB_OUTPUT
            echo "âœ… Build needed: YES"
          else
            echo "build-needed=false" >> $GITHUB_OUTPUT
            echo "âŒ Build needed: NO"
          fi
          
          # Check if projects changed
          if git diff --name-only HEAD~1 | grep "godot-demo-projects/"; then
            echo "projects-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Projects changed: YES"
          else
            echo "projects-changed=false" >> $GITHUB_OUTPUT
            echo "âŒ Projects changed: NO"
          fi
          
          # Check if docs changed
          if git diff --name-only HEAD~1 | grep -E "(README|\.md$|docs/)"; then
            echo "docs-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Docs changed: YES"
          else
            echo "docs-changed=false" >> $GITHUB_OUTPUT
            echo "âŒ Docs changed: NO"
          fi

  build-projects:
    name: ðŸ—ï¸ Build All Godot Projects
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.build-needed == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: true

      - name: Clean any existing export artifacts
        run: |
          echo "ðŸ§¹ Cleaning existing export artifacts from submodules..."
          find godot-demo-projects -name "exports" -type d -exec rm -rf {} + 2>/dev/null || true
          find godot-demo-projects -name "*.wasm" -delete 2>/dev/null || true
          find godot-demo-projects -name "*.pck" -delete 2>/dev/null || true
          echo "Cleaned export artifacts to ensure fresh build"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Godot
        run: |
          echo "ðŸŽ® Setting up Godot Engine ${GODOT_VERSION}..."
          
          # Download Godot for Linux
          GODOT_URL="https://github.com/godotengine/godot-builds/releases/download/${GODOT_VERSION_STABLE}/Godot_v${GODOT_VERSION_STABLE}_linux.x86_64.zip"
          TEMPLATES_URL="https://github.com/godotengine/godot-builds/releases/download/${GODOT_VERSION_STABLE}/Godot_v${GODOT_VERSION_STABLE}_export_templates.tpz"
          
          echo "ðŸ“¥ Downloading Godot ${GODOT_VERSION}..."
          wget -q "${GODOT_URL}" -O godot.zip
          
          echo "ðŸ“¦ Extracting Godot..."
          unzip -q godot.zip
          
          # Make Godot executable and move to a standard location
          chmod +x Godot_v${GODOT_VERSION_STABLE}_linux.x86_64
          sudo mv Godot_v${GODOT_VERSION_STABLE}_linux.x86_64 /usr/local/bin/godot
          
          echo "ðŸ“¥ Downloading export templates..."
          wget -q "${TEMPLATES_URL}" -O export_templates.tpz
          
          echo "ðŸ“¦ Installing export templates..."
          mkdir -p ~/.local/share/godot/export_templates/${GODOT_TEMPLATE_VERSION}
          unzip -q export_templates.tpz -d ~/.local/share/godot/export_templates/
          mv ~/.local/share/godot/export_templates/templates/* ~/.local/share/godot/export_templates/${GODOT_TEMPLATE_VERSION}/
          rmdir ~/.local/share/godot/export_templates/templates
          
          echo "âœ… Godot setup completed"
          godot --version
          
          echo "ðŸ” Verifying export templates..."
          ls -la ~/.local/share/godot/export_templates/${GODOT_TEMPLATE_VERSION}/
          
          echo "ðŸ§¹ Cleaning up downloaded files..."
          rm -f godot.zip export_templates.tpz
          echo "âœ… Cleanup completed"

      - name: Verify Godot installation
        run: |
          echo "ðŸ” Verifying Godot installation..."
          godot --version
          
          echo "ðŸ” Checking export presets..."
          godot --headless --list-export-presets --quit
          
          echo "ðŸ” Verifying export templates are installed..."
          if [ -d ~/.local/share/godot/export_templates/${GODOT_TEMPLATE_VERSION} ]; then
            echo "âœ… Export templates found for version ${GODOT_TEMPLATE_VERSION}"
            ls -la ~/.local/share/godot/export_templates/${GODOT_TEMPLATE_VERSION}/
          else
            echo "âŒ Export templates not found!"
            exit 1
          fi

      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: |
            .build_cache
            build_system/cache
          key: ${{ runner.os }}-godot-${{ env.GODOT_VERSION }}-all-${{ hashFiles('godot-demo-projects/**/*.godot') }}
          restore-keys: |
            ${{ runner.os }}-godot-${{ env.GODOT_VERSION }}-all-
            ${{ runner.os }}-godot-${{ env.GODOT_VERSION }}-

      - name: Build all Godot projects and generate documentation
        run: |
          echo "ðŸ—ï¸ Building all Godot projects with documentation generation..."
          
          # Build all projects and generate documentation in one integrated step
          python build_system/scons_build.py \
            --projects-dir godot-demo-projects \
            --godot-binary godot \
            --godot-version ${{ env.GODOT_VERSION }} \
            --jobs 4 \
            --cache-dir .build_cache \
            --continue-on-error \
            --generate-docs \
            --docs-output _sidebar.md \
            ${{ github.event.inputs.force_rebuild == 'true' && '--force-rebuild' || '' }} \
            --verbose

      - name: Check build results
        run: |
          echo "ðŸŽ¯ Build Results for all projects:"
          find godot-demo-projects -name "*.wasm" -path "*/exports/*" | wc -l | xargs -I {} echo "  Built {} WASM files"
          find godot-demo-projects -name "index.html" -path "*/exports/*" | wc -l | xargs -I {} echo "  Created {} web exports"
          
          echo "ðŸ“š Documentation generated:"
          [ -f "_sidebar.md" ] && echo "  âœ… Sidebar generated" || echo "  âŒ Sidebar missing"
          echo "  Total projects: $(find godot-demo-projects -name project.godot | wc -l)"

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godot-exports-all
          path: godot-demo-projects/
          retention-days: 7
          if-no-files-found: warn

      # Note: Do NOT clean exports here - they're needed for documentation build

      - name: Archive build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-all
          path: |
            .build_cache/build_cache.json
            build_system/logs/
          retention-days: 3

  build-documentation:
    name: ðŸ“š Build Documentation Site
    runs-on: ubuntu-latest
    needs: [detect-changes, build-projects]
    if: always() && (needs.detect-changes.outputs.build-needed == 'true' || needs.detect-changes.outputs.docs-changed == 'true')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download build artifacts
        if: needs.build-projects.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: godot-exports-all
          path: ./built-projects

      - name: Merge exports into documentation
        if: needs.build-projects.result == 'success'
        run: |
          echo "ðŸ”„ Merging built exports into documentation structure..."
          
          # Debug: Check what's actually in the artifact
          echo "ðŸ” Debug: Artifact root contents:"
          ls -la ./built-projects/
          echo ""
          echo "ðŸ” Debug: Looking for export directories anywhere in artifact:"
          find ./built-projects -type d -name "exports" | head -10
          echo ""
          echo "ðŸ” Debug: Looking for project structure:"
          find ./built-projects -name "project.godot" | head -5
          echo ""
          
          # Strategy 1: Check if we have the full godot-demo-projects structure
          if [ -d "./built-projects/godot-demo-projects" ]; then
            echo "ðŸ“‚ Strategy 1: Found nested godot-demo-projects structure"
            rsync -av --include="*/" --include="exports/" --include="exports/**" --exclude="*" \
              ./built-projects/godot-demo-projects/ ./godot-demo-projects/
              
          # Strategy 2: Check if the artifact IS the godot-demo-projects directory (direct upload)
          elif find ./built-projects -name "project.godot" | head -1 | grep -q .; then
            echo "ðŸ“‚ Strategy 2: Artifact contains project files directly"
            rsync -av --include="*/" --include="exports/" --include="exports/**" --exclude="*" \
              ./built-projects/ ./godot-demo-projects/
              
          # Strategy 3: Look for any exports directories and try to reconstruct
          elif find ./built-projects -name "exports" -type d | head -1 | grep -q .; then
            echo "ðŸ“‚ Strategy 3: Found exports directories, reconstructing structure"
            find ./built-projects -name "exports" -type d | while read export_dir; do
              echo "  Processing: $export_dir"
              # Try to extract project path by looking at parent directories
              project_path=$(echo "$export_dir" | sed 's|./built-projects/||' | sed 's|/exports||')
              if [ -n "$project_path" ] && [ "$project_path" != "exports" ]; then
                echo "    Copying to godot-demo-projects/$project_path/"
                mkdir -p "./godot-demo-projects/$project_path"
                cp -r "$export_dir" "./godot-demo-projects/$project_path/"
              fi
            done
            
          else
            echo "âš ï¸  No recognizable export structure found in artifact"
            echo "ðŸ” Complete artifact structure (first 20 files):"
            find ./built-projects -type f | head -20
            echo "âš ï¸  Artifact size: $(du -sh ./built-projects)"
          fi
          
          echo ""
          echo "ðŸ“Š Final export statistics after merge attempt:"
          export_folders=$(find godot-demo-projects -name exports -type d | wc -l)
          wasm_files=$(find godot-demo-projects -name "*.wasm" -path "*/exports/*" | wc -l)
          web_exports=$(find godot-demo-projects -name index.html -path "*/exports/*" | wc -l)
          
          echo "  Export folders: $export_folders"
          echo "  WASM files: $wasm_files"
          echo "  Web exports: $web_exports"
          
          if [ "$export_folders" -gt 0 ]; then
            echo "  âœ… Exports successfully merged!"
            echo "  Sample paths:"
            find godot-demo-projects -name exports -type d | head -3 | sed 's|^|    |'
          else
            echo "  âŒ No exports found after merge - this will cause deployment failure"
          fi
          
          # Clean up temporary directory
          rm -rf ./built-projects

      - name: Process embeds for documentation
        run: |
          echo "ðŸŽ® Processing embeds for documentation site..."
          
          # Always run embed injection after exports are merged to ensure correct URLs
          echo "ðŸ”„ Running embed injection with merged exports..."
          python build_system/builders/embed_injector.py \
            --projects-dir godot-demo-projects \
            --in-place \
            --verbose
          
          echo "ðŸ“Š Verifying embed injection results:"
          embed_count=$(grep -r "game-embed" godot-demo-projects/*/README.md | wc -l)
          echo "  README files with embeds: $embed_count"
          
          if [ "$embed_count" -gt 0 ]; then
            echo "  âœ… Embeds successfully injected"
            echo "  Sample embed URLs:"
            grep -r "src=" godot-demo-projects/*/README.md | head -3 | sed 's/.*src="//;s/".*//' | sed 's|^|    |'
          else
            echo "  âš ï¸  No embeds found after injection"
          fi

      - name: Verify documentation structure
        run: |
          echo "ðŸ“Š Documentation Statistics:"
          echo "  Total projects: $(find godot-demo-projects -name project.godot | wc -l)"
          echo "  With exports: $(find godot-demo-projects -name index.html -path '*/exports/*' | wc -l)"
          echo "  README files: $(find godot-demo-projects -name README.md | wc -l)"
          echo "  Sidebar entries: $(grep -c 'ðŸŽ®\|ðŸ“' _sidebar.md)"
          
          echo ""
          echo "ðŸ” Verifying exports are present for deployment:"
          export_count=$(find godot-demo-projects -name "exports" -type d | wc -l)
          web_count=$(find godot-demo-projects -name index.html -path '*/exports/*' | wc -l)
          wasm_count=$(find godot-demo-projects -name "*.wasm" -path '*/exports/*' | wc -l)
          
          echo "  Export folders: $export_count"
          echo "  Web exports: $web_count" 
          echo "  WASM files: $wasm_count"
          
          # Calculate approximate size
          if [ "$wasm_count" -gt 0 ]; then
            echo ""
            echo "ðŸ“¦ Size estimation:"
            sample_size=$(find godot-demo-projects -name "*.wasm" -path "*/exports/*" -exec du -b {} \; | head -5 | awk '{sum+=$1} END {print sum/NR}')
            if [ -n "$sample_size" ]; then
              total_mb=$((wasm_count * sample_size / 1024 / 1024))
              echo "  Estimated total size: ${total_mb}MB (${wasm_count} WASM files)"
            fi
          fi
          
          if [ "$web_count" -gt 0 ]; then
            echo "  âœ… Web exports found - will be included in site"
            echo "  Sample export URLs that will be available:"
            find godot-demo-projects -name index.html -path '*/exports/*' | head -3 | sed 's|^|    /|'
          else
            echo "  âš ï¸  No web exports found - games won't be playable"
            exit 1
          fi

      - name: Build site with docsify
        run: |
          echo "ðŸŒ Building static documentation site..."
          
          # Install docsify-cli if needed for static generation
          npm install -g docsify-cli
          
          # Verify index.html exists
          if [ ! -f "index.html" ]; then
            echo "Creating index.html for docsify"
            cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>Godot Examples Documentation</title>
            <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
            <meta name="description" content="Interactive documentation for Godot Engine demo projects">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
            <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
          </head>
          <body>
            <div id="app"></div>
            <script>
              window.$docsify = {
                name: 'Godot Examples',
                repo: 'https://github.com/godotengine/godot-demo-projects',
                loadSidebar: true,
                subMaxLevel: 2,
                search: 'auto',
                copyCode: {
                  buttonText : 'Copy to clipboard',
                  errorText  : 'Error',
                  successText: 'Copied'
                }
              }
            </script>
            <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
            <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
            <script src="//cdn.jsdelivr.net/npm/docsify-copy-code@2"></script>
          </body>
          </html>
          EOF
          fi

      - name: Archive documentation site
        uses: actions/upload-artifact@v4
        with:
          name: documentation-site
          path: |
            index.html
            _sidebar.md
            README.md
            DOCS.md
            godot-demo-projects/
            !godot-demo-projects/**/.git
            !godot-demo-projects/**/*.tmp
            !godot-demo-projects/**/*.log
          retention-days: 30

  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-projects, build-documentation]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.build-documentation.result == 'success'
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Download documentation site
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: ./site

      - name: Verify deployment content
        run: |
          echo "ðŸ” Verifying content being deployed to GitHub Pages:"
          echo "  Total files: $(find ./site -type f | wc -l)"
          echo "  Export folders: $(find ./site -name exports -type d | wc -l)"
          echo "  Web exports: $(find ./site -name index.html -path '*/exports/*' | wc -l)"
          
          if [ "$(find ./site -name exports -type d | wc -l)" -gt 0 ]; then
            echo "  âœ… Export folders present in deployment"
            echo "  Sample exports in deployment:"
            find ./site -name index.html -path '*/exports/*' | head -3 | sed 's|^./site||'
          else
            echo "  âŒ No export folders found in deployment!"
            echo "  Site structure:"
            ls -la ./site/
          fi

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [detect-changes, build-projects, build-documentation, deploy]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸŽ® Godot Examples Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Changes | ${{ needs.detect-changes.result }} | Build needed: ${{ needs.detect-changes.outputs.build-needed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Projects | ${{ needs.build-projects.result }} | Projects: ${{ needs.build-projects.result == 'success' && 'âœ… Built successfully' || 'âŒ Build failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Documentation | ${{ needs.build-documentation.result }} | Docs: ${{ needs.build-documentation.result == 'success' && 'âœ… Generated successfully' || 'âŒ Generation failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} | Pages: ${{ needs.deploy.result == 'success' && 'ðŸš€ Deployed successfully' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Deploy failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ðŸŒ **Documentation is live!** Check the [GitHub Pages deployment](https://github.com/${{ github.repository }}/deployments)" >> $GITHUB_STEP_SUMMARY
          fi
